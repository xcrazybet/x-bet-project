<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BET | Professional Gaming Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6; --secondary: #f59e0b; --dark-bg: #05080f;
            --text-main: #ffffff; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.1);
            --success: #10b981; --danger: #ef4444; --nav-height: 80px;
        }

        /* --- Global Reset & Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: var(--dark-bg); color: var(--text-main); 
            font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; 
        }
        body.modal-open { overflow: hidden; } /* 7. Scroll Lock */

        /* --- 8. Logo & Navigation CSS --- */
        .navbar { 
            position: fixed; top: 0; width: 100%; z-index: 2000; 
            background: rgba(5, 8, 15, 0.95); backdrop-filter: blur(15px); 
            border-bottom: 1px solid var(--border); height: var(--nav-height); 
        }
        .nav-container { 
            max-width: 1800px; margin: 0 auto; padding: 0 30px; 
            display: flex; justify-content: space-between; align-items: center; height: 100%; 
        }
        .logo { font-size: 26px; font-weight: 800; color: white; text-decoration: none; letter-spacing: -1px; }
        .logo span { color: var(--primary); }

        .nav-links { display: flex; gap: 25px; align-items: center; }
        .nav-item { text-decoration: none; color: var(--text-dim); font-weight: 600; font-size: 14px; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { color: white; }

        /* --- 3. Spinner Animation Fix --- */
        .sync-spinner { 
            width: 20px; height: 20px; border: 2px solid var(--border); 
            border-top-color: var(--primary); border-radius: 50%; 
            animation: spin 1s infinite linear; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 4 & 7. UI Components (No Inline Styles) --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            z-index: 5000; display: flex; align-items: center; justify-content: center; 
            backdrop-filter: blur(5px); transition: opacity 0.3s ease;
        }
        .modal-content { 
            background: #0f172a; padding: 30px; border-radius: 20px; 
            border: 1px solid var(--border); width: 90%; max-width: 400px; text-align: center; 
        }
        .modal-text-dim { color: var(--text-dim); margin: 15px 0; font-size: 14px; }
        
        .btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: white; }

        .user-pill { 
            display: flex; align-items: center; gap: 12px; 
            background: rgba(255,255,255,0.05); padding: 6px 16px; 
            border-radius: 50px; border: 1px solid var(--border); 
        }
        .balance-val { color: var(--success); font-weight: 800; }

        .hidden { display: none !important; }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 992px) {
            .nav-links { 
                position: fixed; top: var(--nav-height); left: 0; width: 100%; 
                background: #05080f; flex-direction: column; padding: 40px; 
                border-bottom: 1px solid var(--border); transform: translateY(-110%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .nav-links.active { transform: translateY(0); }
            #menuToggle { display: block; background: none; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; }
        }
    </style>
</head>
<body>

    <div id="errorBanner" class="hidden" role="alert" aria-live="polite"></div>

    <div id="logoutModal" class="modal-overlay hidden" aria-modal="true" role="dialog">
        <div class="modal-content">
            <h3>Confirm Logout</h3>
            <p class="modal-text-dim">Your active gaming session will be safely closed.</p>
            <div class="btn-group">
                <button id="closeModal" class="btn btn-outline">Cancel</button>
                <button id="confirmLogout" class="btn btn-danger">Sign Out</button>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-links-wrapper" style="display:flex; align-items:center; gap:20px;">
                <button id="menuToggle" class="hidden" aria-label="Open Menu">â˜°</button>
                <a href="index.html" class="logo">X-<span>BET</span></a>
            </div>
            
            <ul id="navLinks" class="nav-links" role="list">
                <li><a href="index.html" class="nav-item active">Home</a></li>
                <li><a href="games.html" class="nav-item">Games</a></li>
                <li><a href="dashboard.html" id="link-dash" class="nav-item hidden">Dashboard</a></li>
                <li><a href="about.html" class="nav-item">About</a></li>
            </ul>

            <div id="authArea">
                <div class="sync-spinner" role="status" aria-label="Syncing Data"></div>
            </div>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        /* 1. SECURED CONFIG FETCH (Placeholder for your Env Vars) */
        // In a real build, you'd use a bundler (Vite/Webpack) to inject import.meta.env
        const firebaseConfig = {
            apiKey: "PASTE_HERE",
            authDomain: "PASTE_HERE",
            projectId: "PASTE_HERE",
            storageBucket: "PASTE_HERE",
            messagingSenderId: "PASTE_HERE",
            appId: "PASTE_HERE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let unsubscribeFirestore = null;

        // --- Auth & State Management ---
        onAuthStateChanged(auth, (user) => {
            if (unsubscribeFirestore) unsubscribeFirestore();

            if (user) {
                unsubscribeFirestore = onSnapshot(doc(db, "users", user.uid), (snap) => {
                    if (snap.exists()) renderUserUI(snap.data());
                });
            } else {
                renderGuestUI();
            }
        });

        /* 5. MEMORY LEAK CLEANUP */
        window.addEventListener('beforeunload', () => {
            if (unsubscribeFirestore) unsubscribeFirestore();
        });

        // --- Modular Renderers (6. No Global Pollutants) ---
        function renderUserUI(data) {
            document.getElementById('link-dash').classList.remove('hidden');
            document.getElementById('authArea').innerHTML = `
                <div class="user-pill">
                    <span class="balance-val">$${(Number(data.balance) || 0).toLocaleString()}</span>
                    <span class="nav-item" style="font-size:12px;">${data.username}</span>
                    <button id="openLogout" class="btn-outline" style="border:none; cursor:pointer; font-size:14px; margin-left:10px;">Logout</button>
                </div>
            `;
            document.getElementById('openLogout').addEventListener('click', toggleLogoutModal);
        }

        function renderGuestUI() {
            document.getElementById('link-dash').classList.add('hidden');
            document.getElementById('authArea').innerHTML = `
                <a href="login.html" class="btn btn-primary" style="text-decoration:none;">Join Now</a>
            `;
        }

        /* 4. Accessibility & Modal Support */
        function toggleLogoutModal() {
            const modal = document.getElementById('logoutModal');
            const isOpen = modal.classList.toggle('hidden');
            document.body.classList.toggle('modal-open', !isOpen);
            if (!isOpen) document.getElementById('confirmLogout').focus();
        }

        // 4. Modal Keybinds (Escape to close)
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('logoutModal').classList.contains('hidden')) {
                toggleLogoutModal();
            }
        });

        document.getElementById('closeModal').addEventListener('click', toggleLogoutModal);
        document.getElementById('confirmLogout').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (err) {
                console.error("Signout failed", err);
            }
        });

        // 7. Mobile Menu Logic
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('navLinks').classList.toggle('active');
        });
    </script>
</body>
</html>

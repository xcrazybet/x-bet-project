<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BET - Secure Login</title>
    <!-- Firebase SDK with crossorigin -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js" crossorigin="anonymous"></script>
    <style>
        /* [ALL YOUR EXISTING CSS REMAINS THE SAME] */
        /* ... no changes to CSS ... */
    </style>
</head>
<body>
    <!-- [ALL YOUR EXISTING HTML REMAINS THE SAME] -->
    <!-- ... no changes to HTML structure ... -->

    <script>
        // ✅ FIREBASE CONFIGURATION (YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.firebasestorage.app",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962",
            measurementId: "G-PTV4XMYQ6P"
        };

        // Global variables
        let auth = null;
        let db = null;
        let firebaseInitialized = false;

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const messageDiv = document.getElementById('message');
        const secureBadge = document.getElementById('secureBadge');

        // Initialize Firebase for all browsers
        function initializeFirebase() {
            try {
                // Check if Firebase is already initialized
                if (!firebase.apps.length) {
                    // Initialize Firebase
                    firebase.initializeApp(firebaseConfig);
                    console.log("✅ Firebase initialized successfully!");
                } else {
                    // Use existing app
                    console.log("✅ Firebase already initialized");
                }
                
                // Get auth and firestore instances
                auth = firebase.auth();
                db = firebase.firestore();
                firebaseInitialized = true;
                
                // Update UI
                secureBadge.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                    ✅ Authentication Ready • All Browsers Supported
                `;
                secureBadge.style.color = '#10b981';
                secureBadge.style.background = '#f0fdf4';
                
                // Enable login button
                loginBtn.disabled = false;
                
                // Check for existing session
                checkExistingSession();
                
            } catch (error) {
                console.error("❌ Firebase initialization error:", error);
                secureBadge.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    ⚠️ Using Local Authentication Only
                `;
                secureBadge.style.color = '#f59e0b';
                secureBadge.style.background = '#fffbeb';
            }
        }

        // Show message
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}-message`;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Check for existing session
        function checkExistingSession() {
            if (auth && firebaseInitialized) {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        // User is already signed in
                        console.log("User already signed in:", user.email);
                        // ✅ FIXED: Always redirect to index.html, not admin.html
                        createUserSessionAndRedirect(user);
                    }
                });
            }
            
            // Also check local storage for backward compatibility
            const localUser = localStorage.getItem('currentUser');
            const localSession = sessionStorage.getItem('xbet_session');
            
            if (localUser || localSession) {
                // Pre-fill email if available
                if (localUser) {
                    document.getElementById('email').value = localUser;
                }
            }
        }

        // ✅ FIXED: Create session and redirect to index.html
        function createUserSessionAndRedirect(user) {
            // Create session data
            const sessionData = {
                uid: user.uid || 'local_' + Date.now(),
                email: user.email,
                username: user.email ? user.email.split('@')[0] : 'user',
                isAdmin: false, // Always set to false for login.html users
                lastLogin: new Date().toISOString()
            };
            
            // Store session (compatible with all browsers)
            sessionStorage.setItem('xbet_session', btoa(JSON.stringify(sessionData)));
            localStorage.setItem('currentUser', sessionData.username);
            
            // ✅ ALWAYS REDIRECT TO INDEX.HTML
            console.log("Redirecting to index.html...");
            window.location.href = 'index.html';
        }

        // Login with Firebase
        async function loginWithFirebase(email, password) {
            if (!firebaseInitialized) {
                throw new Error('Firebase not initialized');
            }

            try {
                // First, try to sign in with email/password
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log("✅ Firebase login successful:", user.email);
                
                // Get user data from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // Create user document if it doesn't exist
                    await db.collection('users').doc(user.uid).set({
                        uid: user.uid,
                        email: user.email,
                        username: user.email.split('@')[0],
                        balance: 0.00,
                        isAdmin: false, // Regular users are not admin
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        registeredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                return {
                    success: true,
                    user: user,
                    userData: userDoc.exists ? userDoc.data() : null
                };
                
            } catch (error) {
                console.error("Firebase login error:", error.code, error.message);
                throw error;
            }
        }

        // Login with local storage (fallback for Firefox users)
        async function loginWithLocalStorage(email, password) {
            try {
                // Check if user exists in local storage
                const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                
                // Find user by email or username
                let foundUser = null;
                for (const [username, userEmail] of Object.entries(registeredUsers)) {
                    if (userEmail === email || username === email) {
                        foundUser = username;
                        break;
                    }
                }
                
                if (!foundUser) {
                    throw new Error('User not found');
                }
                
                // Get user data
                const userData = JSON.parse(localStorage.getItem('userData_' + foundUser) || '{}');
                
                // Simple password check (in production, this should be hashed)
                if (!userData.email) {
                    throw new Error('Invalid user data');
                }
                
                return {
                    success: true,
                    user: { 
                        email: userData.email, 
                        uid: 'local_' + foundUser 
                    },
                    userData: userData,
                    isLocal: true
                };
                
            } catch (error) {
                console.error("Local login error:", error);
                throw error;
            }
        }

        // Handle form submission
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const emailInput = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // Basic validation
            if (!emailInput || !password) {
                showMessage('Please enter both email and password', 'error');
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.classList.add('loading');
            loginBtn.textContent = '';

            try {
                let result;
                
                // Try Firebase login first
                if (firebaseInitialized) {
                    try {
                        result = await loginWithFirebase(emailInput, password);
                    } catch (firebaseError) {
                        console.log("Firebase login failed, trying local...", firebaseError.message);
                        
                        // Check specific Firebase errors
                        if (firebaseError.code === 'auth/user-not-found' || 
                            firebaseError.code === 'auth/wrong-password') {
                            // Try local storage for migrated users
                            result = await loginWithLocalStorage(emailInput, password);
                        } else {
                            throw firebaseError;
                        }
                    }
                } else {
                    // Use local storage only
                    result = await loginWithLocalStorage(emailInput, password);
                }
                
                if (result.success) {
                    showMessage('✅ Login successful! Redirecting...', 'success');
                    
                    // ✅ FIXED: Always redirect to index.html for ALL users
                    createUserSessionAndRedirect(result.user);
                    
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // User-friendly error messages
                let errorMessage = 'Invalid email or password';
                
                if (error.code) {
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'No account found with this email. Please sign up first.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Incorrect password. Please try again.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Too many failed attempts. Try again later.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Network error. Check your connection and try again.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Please enter a valid email address.';
                            break;
                    }
                } else if (error.message.includes('not found')) {
                    errorMessage = 'Account not found. Please sign up first.';
                }
                
                showMessage('✗ ' + errorMessage, 'error');
                
                // Re-enable button
                loginBtn.disabled = false;
                loginBtn.classList.remove('loading');
                loginBtn.textContent = 'Secure Login';
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing Firebase for browser:", navigator.userAgent);
            
            // Initialize Firebase
            initializeFirebase();
            
            // Check for successful registration redirect
            const registrationSuccess = sessionStorage.getItem('registration_success');
            if (registrationSuccess === 'true') {
                showMessage('✅ Registration successful! Please login with your credentials.', 'success');
                sessionStorage.removeItem('registration_success');
                
                // Pre-fill email if available
                const newUserEmail = sessionStorage.getItem('new_user_email');
                if (newUserEmail) {
                    document.getElementById('email').value = newUserEmail;
                    sessionStorage.removeItem('new_user_email');
                }
            }
            
            // Auto-focus email field
            document.getElementById('email').focus();
            
            // Add browser-specific fixes
            fixBrowserIssues();
        });

        // Browser-specific fixes
        function fixBrowserIssues() {
            const browser = detectBrowser();
            console.log("Detected browser:", browser);
            
            // Firefox specific fixes
            if (browser === 'firefox') {
                // Force re-initialization if Firebase fails
                setTimeout(() => {
                    if (!firebaseInitialized) {
                        console.log("Firefox: Re-trying Firebase initialization...");
                        initializeFirebase();
                    }
                }, 1000);
            }
            
            // Safari specific fixes
            if (browser === 'safari') {
                // Safari has strict CORS policies
                console.log("Safari: Applying CORS workarounds...");
            }
        }

        // Detect browser
        function detectBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('firefox')) return 'firefox';
            if (userAgent.includes('safari') && !userAgent.includes('chrome')) return 'safari';
            if (userAgent.includes('chrome')) return 'chrome';
            if (userAgent.includes('edge')) return 'edge';
            return 'unknown';
        }

        // Test credentials for development (remove in production)
        function testLogin(email = 'test@example.com', password = 'Test123!') {
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
            loginForm.dispatchEvent(new Event('submit'));
        }
        
        // Uncomment for testing
        // window.testLogin = testLogin;
    </script>
</body>
</html>

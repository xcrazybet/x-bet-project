<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BET | Secure Authentication</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --bg: #020617; --card: #0f172a; --border: #1e293b; --error: #ef4444; }
        body { background: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        .auth-card { 
            background: var(--card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); 
            width: 100%; max-width: 400px; animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .input-group { margin-bottom: 20px; position: relative; }
        label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500; }
        
        input { 
            width: 100%; background: #1e293b; border: 1px solid var(--border); padding: 14px; 
            border-radius: 12px; color: white; font-size: 15px; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        input.invalid { border-color: var(--error); }

        .toggle-pass { 
            position: absolute; right: 14px; top: 38px; color: #94a3b8; 
            background: none; border: none; cursor: pointer; font-size: 11px; font-weight: 700;
            padding: 5px; border-radius: 4px;
        }
        .toggle-pass:hover { color: white; }

        .btn { 
            width: 100%; padding: 14px; background: var(--primary); border: none; border-radius: 12px; 
            color: white; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: 0.3s;
        }
        .btn:hover:not(:disabled) { background: #2563eb; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ARIA Live Region Styles */
        .error-box { 
            color: var(--error); font-size: 13px; margin-bottom: 20px; text-align: center; 
            display: none; padding: 12px; background: rgba(239, 68, 68, 0.1); 
            border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body>

    <div class="auth-card" role="main">
        <h1 style="margin-bottom: 8px; font-size: 24px;">Institutional Login</h1>
        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 30px;">Access your secure command center.</p>
        
        <div id="errorBox" class="error-box" role="alert" aria-live="assertive"></div>

        <div class="input-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" placeholder="name@company.com" required autocomplete="email">
        </div>

        <div class="input-group">
            <label for="password">Security Password</label>
            <input type="password" id="password" placeholder="••••••••" required autocomplete="current-password">
            <button type="button" class="toggle-pass" onclick="togglePass()" aria-label="Toggle password visibility">SHOW</button>
        </div>

        <div style="text-align: right; margin-bottom: 20px;">
            <button onclick="handleReset()" style="background:none; border:none; color: var(--primary); font-size: 12px; cursor:pointer; font-weight: 600;">Forgot Password?</button>
        </div>

        <button class="btn" id="loginBtn" onclick="handleLogin()">
            <div class="spinner" id="btnSpinner" aria-hidden="true"></div>
            <span id="btnText">Sign In to Dashboard</span>
        </button>

        <p style="text-align: center; margin-top: 25px; font-size: 14px; color: #94a3b8;">
            New agent? <a href="signup.html" style="color: var(--primary); text-decoration: none; font-weight: 600;">Request Access</a>
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { firebaseConfig } from "./js/config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // UI Utility: Toggle Password Visibility
        window.togglePass = () => {
            const p = document.getElementById('password');
            const btn = document.querySelector('.toggle-pass');
            const isPass = p.type === 'password';
            p.type = isPass ? 'text' : 'password';
            btn.innerText = isPass ? 'HIDE' : 'SHOW';
        };

        // UI Utility: Handle Password Reset
        window.handleReset = async () => {
            const email = document.getElementById('email').value.trim();
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                showErr("Enter your email address first to reset password.");
                document.getElementById('email').focus();
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Reset link sent to your email!");
            } catch (err) {
                showErr("Could not send reset link. Verify email address.");
            }
        };

        window.handleLogin = async () => {
            const emailEl = document.getElementById('email');
            const passEl = document.getElementById('password');
            const btn = document.getElementById('loginBtn');
            
            const email = emailEl.value.trim();
            const password = passEl.value;

            // 1. Client-side Validation (Pre-Firebase)
            emailEl.classList.remove('invalid');
            passEl.classList.remove('invalid');

            if (!/^\S+@\S+\.\S+$/.test(email)) {
                showErr("Please enter a valid institutional email.");
                emailEl.classList.add('invalid');
                emailEl.focus();
                return;
            }

            if (password.length < 6) {
                showErr("Password must be at least 6 characters.");
                passEl.classList.add('invalid');
                passEl.focus();
                return;
            }

            setLoading(true);

            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
                window.location.href = "dashboard.html";
            } catch (err) {
                showErr(mapError(err.code));
                setLoading(false);
                // Auto-focus the password field on failure
                passEl.value = "";
                passEl.focus();
            }
        };

        function showErr(m) {
            const b = document.getElementById('errorBox');
            b.innerText = m;
            b.style.display = 'block';
        }

        function setLoading(s) {
            const btn = document.getElementById('loginBtn');
            btn.disabled = s;
            document.getElementById('btnSpinner').style.display = s ? 'block' : 'none';
            document.getElementById('btnText').innerText = s ? 'Authenticating...' : 'Sign In to Dashboard';
        }

        function mapError(c) {
            switch(c) {
                case 'auth/user-not-found': return "No account linked to this email address.";
                case 'auth/wrong-password': return "Security credentials invalid. Access denied.";
                case 'auth/too-many-requests': return "Account locked due to unusual activity. Try later.";
                case 'auth/invalid-credential': return "Incorrect email or password.";
                default: return "Connection failed. Please verify your network.";
            }
        }
    </script>
</body>
</html>

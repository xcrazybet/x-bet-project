<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BET - Sign Up</title>
    <!-- Include Sync System -->
    <script src="sync.js"></script>
    <style>
        /* [Keep all your existing CSS styles] */
        /* ... existing CSS ... */
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML structure] -->
    <!-- ... existing HTML ... -->

    <script>
        // üî• UPDATED SIGNUP SYSTEM - Uses Universal Sync
        document.addEventListener('DOMContentLoaded', function() {
            console.log("=== X-BET SIGNUP (Universal Sync) ===");
            
            // Check if already logged in
            if (sessionStorage.getItem('xbet_session')) {
                window.location.href = 'index.html';
                return;
            }
            
            const signupForm = document.getElementById('signupForm');
            const messageDiv = document.getElementById('message');
            
            // Check if sync system is loaded
            if (!window.xbetSync) {
                showMessage('‚ö†Ô∏è Sync system not loaded. Please refresh.', 'error');
                console.error('Sync system not found');
            }
            
            // Auto-fill test account
            window.autoFillTest = function() {
                document.getElementById('username').value = 'player' + Math.floor(Math.random() * 10000);
                document.getElementById('email').value = 'test' + Date.now() + '@xbet.com';
                document.getElementById('password').value = 'Test123!';
                document.getElementById('confirmPassword').value = 'Test123!';
            }
            
            function showMessage(text, type) {
                messageDiv.innerHTML = text;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Generate transaction code
            function generateTransactionCode(username) {
                return window.xbetSync.generateTransactionCode(username);
            }
            
            // Validate email
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            // Validate username
            function isValidUsername(username) {
                const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
                return usernameRegex.test(username);
            }
            
            // üî• UNIVERSAL USER REGISTRATION
            function registerUserUniversal(username, email, password, transactionCode) {
                console.log('Starting universal registration for:', username);
                
                // Create user data
                const userData = {
                    username: username,
                    email: email,
                    password: password, // Note: In production, hash this!
                    balance: 0.00,
                    gameBalance: 0.00,
                    transactionCode: transactionCode,
                    status: 'active'
                };
                
                // Use the sync system to register user
                try {
                    const userId = window.xbetSync.registerUser(userData);
                    
                    if (userId) {
                        console.log('‚úÖ User registered with ID:', userId);
                        
                        // Also save to traditional formats for immediate access
                        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                        registeredUsers[username] = email;
                        localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                        
                        // Create detailed user data
                        const detailedData = {
                            username: username,
                            email: email,
                            password: password,
                            balance: 0.00,
                            gameBalance: 0.00,
                            transactionCode: transactionCode,
                            isAdmin: false,
                            status: 'active',
                            registeredAt: new Date().toISOString(),
                            lastLogin: new Date().toISOString(),
                            activities: [{
                                id: 'ACT-' + Date.now(),
                                type: 'account_created',
                                amount: 0,
                                date: new Date().toISOString(),
                                code: 'REG-' + Date.now().toString(36).toUpperCase(),
                                title: 'Account Created',
                                description: 'Welcome to X-BET',
                                status: 'completed'
                            }]
                        };
                        
                        localStorage.setItem('userData_' + username, JSON.stringify(detailedData));
                        
                        return true;
                    } else {
                        console.error('Failed to register user');
                        return false;
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    return false;
                }
            }
            
            // Create user session
            function createUserSession(username, email, transactionCode) {
                const sessionData = {
                    username: username,
                    email: email,
                    transactionCode: transactionCode,
                    isAdmin: false,
                    lastLogin: new Date().toISOString(),
                    loginTime: Date.now(),
                    balance: 0,
                    gameBalance: 0,
                    sessionId: 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                };
                
                sessionStorage.setItem('xbet_session', btoa(JSON.stringify(sessionData)));
                localStorage.setItem('currentUser', username);
                localStorage.setItem('session_expiry', Date.now() + 86400000);
                
                // Update user's last login
                const userData = JSON.parse(localStorage.getItem('userData_' + username) || '{}');
                userData.lastLogin = new Date().toISOString();
                localStorage.setItem('userData_' + username, JSON.stringify(userData));
            }
            
            // Main signup function
            signupForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const email = document.getElementById('email').value.trim().toLowerCase();
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Validation
                if (!username || !email || !password || !confirmPassword) {
                    showMessage('‚ùå Please fill all fields', 'error');
                    return;
                }
                
                if (!isValidUsername(username)) {
                    showMessage('‚ùå Username must be 3-20 characters (letters, numbers, underscores only)', 'error');
                    return;
                }
                
                if (!isValidEmail(email)) {
                    showMessage('‚ùå Please enter a valid email address', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showMessage('‚ùå Password must be at least 6 characters', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showMessage('‚ùå Passwords do not match', 'error');
                    return;
                }
                
                // Check if user exists locally
                const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                if (registeredUsers[username]) {
                    showMessage('‚ùå Username already taken', 'error');
                    return;
                }
                
                // Check if email exists
                for (const existingEmail of Object.values(registeredUsers)) {
                    if (existingEmail === email) {
                        showMessage('‚ùå Email already registered', 'error');
                        return;
                    }
                }
                
                // Check in universal storage via sync system
                const allUsers = window.xbetSync.getAllUsers();
                if (allUsers.find(u => u.username === username)) {
                    showMessage('‚ùå Username already exists in system', 'error');
                    return;
                }
                
                // Generate transaction code
                const transactionCode = generateTransactionCode(username);
                
                // Show loading
                showMessage('üîÑ Creating account and syncing across browsers...', 'success');
                
                // Disable form
                signupForm.querySelectorAll('input, button').forEach(element => {
                    element.disabled = true;
                });
                
                // Register user with universal sync
                const success = await registerUserUniversal(username, email, password, transactionCode);
                
                if (!success) {
                    showMessage('‚ùå Error creating account. Please try again.', 'error');
                    signupForm.querySelectorAll('input, button').forEach(element => {
                        element.disabled = false;
                    });
                    return;
                }
                
                // Create user session
                createUserSession(username, email, transactionCode);
                
                // Get sync status
                const syncStatus = window.xbetSync.getSyncStatus();
                
                // Show success message
                showMessage(`
                    ‚úÖ <strong>Account Created Successfully!</strong><br><br>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px; margin: 10px 0;">
                        <strong style="color: var(--accent);">Your Transaction Code:</strong><br>
                        <code style="font-family: monospace; font-size: 16px; color: var(--success); word-break: break-all;">${transactionCode}</code>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px;">
                        üìä <strong>Sync Status:</strong><br>
                        ‚Ä¢ Browser: ${syncStatus.browser}<br>
                        ‚Ä¢ Universal Users: ${syncStatus.universalUsers}<br>
                        ‚Ä¢ Last Sync: ${syncStatus.lastSync}<br>
                        ‚Ä¢ Your account is now available on ALL browsers!
                    </div>
                    <small>Redirecting to dashboard...</small>
                `, 'success');
                
                // Force immediate sync
                setTimeout(() => {
                    window.xbetSync.syncNow();
                }, 1000);
                
                // Redirect to dashboard after 4 seconds
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 4000);
            });
            
            // Test sync system button
            window.testSync = function() {
                const status = window.xbetSync.getSyncStatus();
                alert(`Sync System Status:\n\nBrowser: ${status.browser}\nUniversal Users: ${status.universalUsers}\nLocal Users: ${status.localUsers}\nLast Sync: ${status.lastSync}\nSync Active: ${status.syncActive ? 'Yes' : 'No'}`);
            };
            
            // Add test button to page
            setTimeout(() => {
                const form = document.querySelector('form');
                if (form) {
                    const testBtn = document.createElement('button');
                    testBtn.type = 'button';
                    testBtn.className = 'btn btn-secondary';
                    testBtn.textContent = 'Test Sync System';
                    testBtn.onclick = window.testSync;
                    testBtn.style.marginTop = '10px';
                    form.appendChild(testBtn);
                }
            }, 1000);
            
            // Initialize
            document.getElementById('username').focus();
        });
    </script>
</body>
</html>

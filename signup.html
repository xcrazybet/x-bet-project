<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BET | Institutional Sign Up</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --bg: #020617; --card: #0f172a; --border: #1e293b; --error: #ef4444; }
        body { background: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        .auth-card { 
            background: var(--card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); 
            width: 100%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .input-group { margin-bottom: 18px; position: relative; }
        label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500; }
        
        input { 
            width: 100%; background: #1e293b; border: 1px solid var(--border); padding: 14px; 
            border-radius: 12px; color: white; font-size: 15px; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); background: #1e293b; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); outline: none; }

        /* Password Strength Meter */
        .strength-meter { height: 4px; width: 100%; background: #334155; margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .strength-bar { height: 100%; width: 0%; transition: 0.3s; }

        .btn { 
            width: 100%; padding: 14px; background: var(--primary); border: none; border-radius: 12px; 
            color: white; font-weight: 700; cursor: pointer; transition: 0.2s; margin-top: 10px;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-box { 
            background: rgba(239, 68, 68, 0.1); color: var(--error); padding: 12px; 
            border-radius: 8px; font-size: 13px; margin-bottom: 20px; display: none; border: 1px solid rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body>

    <div class="auth-card">
        <h2 style="margin-bottom: 8px; font-size: 28px;">Secure Join</h2>
        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 25px;">Create your institutional gaming profile.</p>
        
        <div id="errorBox" class="error-box"></div>

        <div class="input-group">
            <label>Full Username</label>
            <input type="text" id="username" placeholder="e.g. Alpha_Trader" required>
        </div>

        <div class="input-group">
            <label>Corporate Email</label>
            <input type="email" id="email" placeholder="name@company.com" required>
        </div>

        <div class="input-group">
            <label>Access Password</label>
            <input type="password" id="password" placeholder="Min. 8 characters" oninput="checkStrength(this.value)" required>
            <div class="strength-meter"><div id="strengthBar" class="strength-bar"></div></div>
        </div>

        <div class="input-group">
            <label>Confirm Password</label>
            <input type="password" id="confirmPassword" placeholder="Repeat password" required>
        </div>

        <button class="btn" id="signupBtn" onclick="handleSignup()">
            <span class="spinner" id="btnSpinner"></span>
            <span id="btnText">Initialize Account</span>
        </button>

        <p style="text-align: center; margin-top: 25px; font-size: 14px; color: #94a3b8;">
            Registered? <a href="login.html" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign In</a>
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { firebaseConfig } from "./js/config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Helpers
        window.checkStrength = (p) => {
            const bar = document.getElementById('strengthBar');
            let strength = 0;
            if (p.length > 7) strength += 25;
            if (/[A-Z]/.test(p)) strength += 25;
            if (/[0-9]/.test(p)) strength += 25;
            if (/[^A-Za-z0-9]/.test(p)) strength += 25;
            
            bar.style.width = strength + '%';
            bar.style.backgroundColor = strength < 50 ? '#ef4444' : strength < 100 ? '#f59e0b' : '#10b981';
        };

        window.handleSignup = async () => {
            const fields = {
                user: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                pass: document.getElementById('password').value,
                conf: document.getElementById('confirmPassword').value
            };

            // 1. Validation Logic
            if (fields.user.length < 4) return showError("Username must be at least 4 characters.");
            if (!/^\S+@\S+\.\S+$/.test(fields.email)) return showError("Invalid email format.");
            if (fields.pass.length < 8) return showError("Password must be at least 8 characters.");
            if (fields.pass !== fields.conf) return showError("Passwords do not match.");

            toggleLoading(true);

            try {
                const cred = await createUserWithEmailAndPassword(auth, fields.email, fields.pass);
                const txCode = "XB-" + Math.floor(100000 + Math.random() * 900000);

                await setDoc(doc(db, "users", cred.user.uid), {
                    username: fields.user,
                    email: fields.email,
                    txCode: txCode,
                    balance: 0.00,
                    wins: 0.00,
                    role: 'user',
                    history: [{ id: crypto.randomUUID(), type: 'system', amount: 0, note: 'Profile Created', timestamp: Date.now() }]
                });

                window.location.href = "dashboard.html";
            } catch (err) {
                showError(mapError(err.code));
                toggleLoading(false);
            }
        };

        function showError(msg) {
            const box = document.getElementById('errorBox');
            box.innerText = msg;
            box.style.display = 'block';
            window.scrollTo(0,0);
        }

        function toggleLoading(isLoading) {
            document.getElementById('signupBtn').disabled = isLoading;
            document.getElementById('btnSpinner').style.display = isLoading ? 'block' : 'none';
            document.getElementById('btnText').innerText = isLoading ? 'Provisioning...' : 'Initialize Account';
        }

        function mapError(code) {
            switch(code) {
                case 'auth/email-already-in-use': return "This email is already registered.";
                case 'auth/invalid-email': return "The email address is poorly formatted.";
                default: return "Registration failed. Please try again.";
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BET | Secure Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6; --bg-dark: #020617; --card-bg: #0f172a;
            --border: #1e293b; --text-main: #f8fafc; --text-dim: #94a3b8;
            --success: #10b981; --danger: #ef4444;
        }

        /* Loading Skeleton Animation */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading-skeleton { animation: pulse 1.5s infinite; color: var(--text-dim) !important; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); line-height: 1.6; }

        .navbar { 
            height: 72px; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(12px);
            position: sticky; top: 0; z-index: 100;
        }

        .main-grid {
            display: grid; grid-template-columns: 300px 1fr; gap: 32px;
            max-width: 1440px; margin: 32px auto; padding: 0 40px;
        }

        .glass-card {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 16px; padding: 24px; will-change: transform;
        }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-value { font-size: 28px; font-weight: 700; margin-top: 8px; }

        /* Form Styling */
        .input-group { margin-bottom: 20px; }
        input {
            width: 100%; background: #1e293b; border: 1px solid var(--border);
            padding: 12px 16px; border-radius: 8px; color: white; transition: border 0.2s;
        }
        input:focus { border-color: var(--primary); outline: none; }

        .btn {
            width: 100%; padding: 14px; border-radius: 10px; border: none;
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            background: var(--primary); color: white;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th { text-align: left; color: var(--text-dim); font-size: 12px; padding: 12px; border-bottom: 1px solid var(--border); }
        .history-table td { padding: 16px 12px; font-size: 14px; border-bottom: 1px solid var(--border); }

        /* Hidden Accessibility Text */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    </style>
</head>
<body>

    <nav class="navbar" role="navigation" aria-label="Main Navigation">
        <a href="index.html" class="logo" style="text-decoration:none; color:white; font-weight:800; font-size:22px;">X-BET<span style="color:var(--primary)">.PRO</span></a>
        <button onclick="handleSignOut()" class="btn" style="width:auto; background:transparent; border:1px solid var(--danger); color:var(--danger); padding:8px 16px;">Sign Out</button>
    </nav>

    <main class="main-grid">
        <aside>
            <section class="glass-card" style="text-align: center;" aria-labelledby="profile-heading">
                <div id="avatar" role="img" aria-label="User Avatar" style="width: 80px; height: 80px; background: var(--primary); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700;">?</div>
                <h2 id="userName" class="loading-skeleton">Loading...</h2>
                <p id="userEmail" style="font-size: 13px; color: var(--text-dim); margin-bottom: 20px;">---</p>
                <div style="background: #020617; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    <span class="sr-only">Your unique transaction identifier is</span>
                    <div id="userTxCode" style="font-family: monospace; font-weight: 700; color: var(--primary);">XB-000000</div>
                </div>
            </section>
        </aside>

        <section aria-label="Financial Overview">
            <div class="stat-grid">
                <article class="glass-card">
                    <h3 style="font-size:12px; color:var(--text-dim); text-transform:uppercase;">Main Balance</h3>
                    <div class="stat-value" id="bal-main">$0.00</div>
                </article>
                <article class="glass-card">
                    <h3 style="font-size:12px; color:var(--text-dim); text-transform:uppercase;">Total Earnings</h3>
                    <div class="stat-value" id="bal-earnings" style="color: var(--success);">$0.00</div>
                </article>
                <article class="glass-card">
                    <h3 style="font-size:12px; color:var(--text-dim); text-transform:uppercase;">Active Wagers</h3>
                    <div class="stat-value" id="bal-wagers">$0.00</div>
                </article>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 32px;">
                <section class="glass-card" aria-labelledby="transfer-heading">
                    <h3 id="transfer-heading" style="margin-bottom: 24px;">Secure Transfer</h3>
                    <div id="error-msg" role="alert" style="color:var(--danger); font-size:13px; margin-bottom:10px; display:none;"></div>
                    
                    <div class="input-group">
                        <label for="recipientId">Recipient XB-ID</label>
                        <input type="text" id="recipientId" placeholder="XB-123456" aria-required="true">
                    </div>
                    <div class="input-group">
                        <label for="transferAmt">Amount ($)</label>
                        <input type="number" id="transferAmt" placeholder="0.00" step="0.01" aria-required="true">
                    </div>
                    <button id="transferBtn" onclick="executeTransfer()" class="btn">Confirm Secure Transfer</button>
                </section>

                <section class="glass-card" aria-labelledby="activity-heading">
                    <h3 id="activity-heading" style="margin-bottom: 20px;">Recent Activity</h3>
                    <div style="max-height: 350px; overflow-y: auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th scope="col">TYPE</th>
                                    <th scope="col">AMOUNT</th>
                                    <th scope="col">DATE</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, increment, arrayUnion, query, collection, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { firebaseConfig } from "./js/config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Constants for limits
        const MIN_TRANSFER = 1.00;
        const MAX_TRANSFER = 5000.00;

        // Security: Sanitize all inputs
        const sanitize = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML.replace(/[<>]/g, '');
        };

        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = "login.html"; return; }
            onSnapshot(doc(db, "users", user.uid), (snap) => {
                if (snap.exists()) renderDashboard(snap.data(), user.email);
            });
        });

        function renderDashboard(data, email) {
            const nameEl = document.getElementById('userName');
            nameEl.innerText = sanitize(data.username || "Investor");
            nameEl.classList.remove('loading-skeleton');
            
            document.getElementById('userEmail').innerText = email;
            document.getElementById('userTxCode').innerText = data.txCode || "XB-PENDING";
            document.getElementById('bal-main').innerText = `$${(data.balance || 0).toLocaleString()}`;
            document.getElementById('bal-earnings').innerText = `$${(data.wins || 0).toLocaleString()}`;
            
            const hBody = document.getElementById('historyBody');
            hBody.innerHTML = (data.history || []).slice().reverse().map(item => `
                <tr>
                    <td><strong>${sanitize(item.type.toUpperCase())}</strong></td>
                    <td style="color:${item.amount >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:700">
                        ${item.amount >= 0 ? '+' : ''}${item.amount.toFixed(2)}
                    </td>
                    <td style="color:var(--text-dim); font-size:12px;">${new Date(item.timestamp).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        window.executeTransfer = async () => {
            const btn = document.getElementById('transferBtn');
            const errorEl = document.getElementById('error-msg');
            const rid = sanitize(document.getElementById('recipientId').value);
            const amt = parseFloat(document.getElementById('transferAmt').value);

            // 1. Client-side Validation & Limits
            if (isNaN(amt) || amt < MIN_TRANSFER || amt > MAX_TRANSFER) {
                errorEl.innerText = `Transfers must be between $${MIN_TRANSFER} and $${MAX_TRANSFER}`;
                errorEl.style.display = "block";
                return;
            }

            btn.disabled = true;
            btn.innerText = "Processing...";

            try {
                const q = query(collection(db, "users"), where("txCode", "==", rid));
                const qSnap = await getDocs(q);
                if (qSnap.empty) throw new Error("Recipient ID not found.");
                
                const rDoc = qSnap.docs[0];
                const sRef = doc(db, "users", auth.currentUser.uid);

                // 2. Atomic Transaction
                await runTransaction(db, async (tx) => {
                    const sSnap = await tx.get(sRef);
                    if (sSnap.data().balance < amt) throw new Error("Insufficient balance.");

                    const isoDate = new Date().toISOString(); // Standardized format

                    tx.update(sRef, {
                        balance: increment(-amt),
                        history: arrayUnion({ type: 'transfer', amount: -amt, timestamp: isoDate })
                    });
                    tx.update(rDoc.ref, {
                        balance: increment(amt),
                        history: arrayUnion({ type: 'receive', amount: amt, timestamp: isoDate })
                    });

                    // 3. Create Audit Trail Entry
                    await addDoc(collection(db, "audit_logs"), {
                        sender: auth.currentUser.uid,
                        recipient: rDoc.id,
                        amount: amt,
                        timestamp: isoDate,
                        status: 'completed'
                    });
                });

                alert("Transfer Securely Completed.");
                document.getElementById('transferAmt').value = "";
            } catch (err) {
                errorEl.innerText = err.message;
                errorEl.style.display = "block";
            } finally {
                btn.disabled = false;
                btn.innerText = "Confirm Secure Transfer";
            }
        };

        window.handleSignOut = () => signOut(auth);
    </script>
</body>
</html>
